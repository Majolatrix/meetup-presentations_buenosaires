---
title: "Domar datos con `dplyr` y `tidyr`"
author: 'M. Salmon'
date: '`r Sys.Date()`'

output: 
  revealjs::revealjs_presentation:
    css: rladies_revealjs.css
    highlight: pygments
    transition: slide
    
---
```{r}

```

# Agradecimientos

## R-Ladies Barcelona

### Maëlle Salmon

<br/ >
El contenido del Taller está basado en el taller dictado por Maëlle en Barcelona `r emo::ji("purple_heart")`

# Introducción

## Qué es el "tidyverse"?

* Suite de paquetes de R packages diseñados en su mayoría por Hadley Wickham (australiano).

* Diseñados para "caer en un pozo de éxito" (sus palabras `r emo::ji("joy")` )

* http://tidyverse.org/

* *Data wrangling* (luchar con datos?), visualización, modelización, desarrollo de paquetes.

## Por qué hacer este tutorial?

* Usar `dplyr` y `tidyr` = Más fácil que _**$**_ (de R base).

* Otra alternativa a `dplyr` es `data.table`, quizás otro tutorial?

* Quizás acá descubrís el tidyverse `r emo::ji("smiley")`

# Manos a la obra!

## Instalaciones varias

* `dplyr`, `tidyr` y `lubridate` instalados?

* Creá un nuevo .Rproj

* Guardá los datos en una carpeta "data/"

## Dar un vistazo 

Cuando cargamos datos en R, qué hacemos para ver lo que hay dentro? 

## Dar un vistazo

```r
library("dplyr")
load("data/latestData.RData")
class(latestData)
print(latestData)
latestData
View(latestData)
glimpse(latestData)
summary(latestData)
```

## Agregar/quitar columnas

En tu tabla pueden haber columnas que no necesitás, podés querer agregar algo o cambiar algo.
Por ejemplo si tenés una columna con nombres en letras minúsculas y la querés con mayúsculas.

## Agregar/quitar columnas

```r
# Si no me interesan algunas columnas

latestData <- select(latestData, 
- cityURL, - locationURL, 
- longitude, - latitude)
```

## Agregar/quitar columnas

```r
# Nueva variable con letras minúsculas
latestData <- mutate(latestData, 
smallCountry = tolower(country))

# Nueva variable 
latestData <- mutate(latestData, 
biggerValue = value + 10)
```

## Agregar/quitar columnas

Podés filtrar filas que cumplen algún criterio, o eliminar las filas repetidas.

## Agregar/quitar columnas

```r
# O si quiero solo los datos (values) 
# positivos
filter(latestData, value > 0)

# O solo los datos para Mongolia
filter(latestData, country == "MN")
```

## Agregar/quitar columnas

```r
# O solo los datos positivos para 
# Mongolia

filter(latestData, country == "MN", 
value > 0)

filter(latestData, city %in% 
c("Ulaanbaatar", "Farmington"))
```

## Piping! (tuberías)

Acá vemos cómo el uso de tuberías hace tu codigo más legible.

## Piping! (tuberías)

```r
load("data/meas100ail.RData")

# sin tubos
meas100ail2 <- mutate(meas100ail, 
biggerValue = value + 10)
meas100ail2 <- select(meas100ail2, 
- cityURL, - locationURL)
meas100ail2 <- mutate(meas100ail2, 
countrySmall = tolower(country))
meas100ail2 <- select(meas100ail2, 
- country)
```

## Piping! (tuberías)

```r
# con tuberías
meas100ail2 <- meas100ail %>%
  mutate(biggerValue = value + 10) %>%
  select(- cityURL, - locationURL) %>%
  mutate(countrySmall = tolower(country)) %>%
  select(- country)
```

## Ordenar columnas

Podés querer la última columna es en otro lugar.

## Ordenar columnas

```r
# quiero lastUpdated y value al principio

latestData <-  select(latestData, lastUpdated, 
value, everything())

# Qué pasa si no uso everything?
select(latestData, lastUpdated, value)
```

## Ordenar filas

Se puede ordenar la tabla para tener por ejemplo los individuos más pequeños al principio y los más grandes al final.

## Ordenar filas

```r
# ordenar por value
latestData <- arrange(latestData, value)

# ordenar por longitude y después por 
# latitude
latestData <- arrange(latestData, 
longitude, latitude)
```

## Ordenar filas

```r
# ordenar por longitude del más grande 
# al más chico, y después por latitude
latestData <- arrange(latestData, 
desc(longitude), latitude)
```

## Trabajar con grupos

Cómo crear una nueva variable con valor que depende de un grupo.
Por ejemplo: en una tabla de individuos con varios grupos de edad, qué persona es la más alta en cada grupo, la segunda mas alta, etc.

## Trabajar con grupos

```r
# en cada país, orden de value
latestData %>%
  group_by(country) %>% 
  mutate(rankingValue = rank(value)) %>%
  select(location, city, country, 
      value, rankingValue) %>%
  arrange(country) %>%
  ungroup()
```

## Trabajar con grupos

```r
# ahora quiero ver la segunda 
# "location" en cada pais
latestData %>%
  group_by(country) %>% 
  mutate(rankingValue = rank(value)) %>%
  select(location, city, country, value, rankingValue) %>%
  arrange(country) %>%
filter(rankingValue == 2)
```

## Resumir datos

Con dplyr es posible calcular por ejemplo la mediana de la edad en cada país, si tienes una tabla con las columnas individuo, país, edad.

## Resumir datos

```r
# media para cada parámetro
meas100ail %>% 
  group_by(parameter) %>% 
  summarize(mean = mean(value))

# o algo más que la media
meas100ail %>% 
  group_by(parameter) %>% 
  summarize(mean = mean(value),
            min = min(value),
max = max(value))
```

## Resumir datos

```r
# es posible calcular la media para cada 
# parámetro y para cada año
library("lubridate")
meas100ail %>% 
  mutate(year = year(dateLocal)) %>%
  group_by(parameter, year) %>% 
  summarize(mean = mean(value),
            min = min(value),
            max = max(value))

```

## Resumir datos

```r
# si queremos también tener el número 
# de observaciones
meas100ail %>% 
  group_by(parameter) %>% 
  summarize(mean = mean(value),
            min = min(value),
            max = max(value),
            n = n())
```

## Transformar la tabla

Esto es magia! `r emo:ji("raised_hands")` Por ejemplo se puede transformar una tabla "a lo ancho" en una table "a lo largo".

## Transformar la tabla

```r
load("data/meas100ail.RData")
# hay lineas repetidas
meas100ail <- unique(meas100ail)
# Qué hay acá?
glimpse(meas100ail)

# de "largo" a "ancho"
widemeas <- spread(meas100ail, parameter, value)
# si cometo un error
spread(meas100ail, value, parameter)
```

## Transformar la tabla

```r
# de "ancho" a "largo"
gather(widemeas, parameter, value, co:so2)

# o si sólo quiero lineas con value
gather(widemeas, parameter, value, 
co:so2, na.rm = TRUE)

```

## Transformar la tabla

```r
# "date" y "time" separados
meas100ail <- separate(meas100ail, 
  dateLocal, c("date", "time"), sep = " ")

# de nuevo quiero "date" y "time"
library("lubridate")
meas100ail <- mutate(meas100ail, 
 date = as_date(ymd(date)), time = hms(time))

# "value" y "unit" juntos
unite(meas100ail, niceValue, 
 c(value, unit), sep = " ")
```

## Mezclar tablas (merge)

Si tenés una tabla con la edad de individuos y su número de identificación, y otra tabla con el peso de individuos y su numero de identificación. Cómo crear una única tabla con estas dos tablas?

## Mezclar tablas (merge)
```r
load("data/latestData.RData")
load("data/countries.RData")
load("data/moreData.RData")

# agregar lineas
bind_rows(latestData, moreData)

# si no tienen las mismas columnas
latestData2 <- select(latestData, location, city)
bind_rows(latestData2, moreData)
```
## Mezclar tablas (merge)

```r
# agregar el nombre de los países
glimpse(latestData)
glimpse(countries)

left_join(latestData, countries, 
  by = c("country" = "code"))

left_join(latestData, countries, 
  by = c("country" = "code")) %>%
     mutate(country = name) %>%
     select(- name)
```

## RStudio "cheatsheet"

Están muy buenas!

Preguntas?

![](https://media.giphy.com/media/vxVcOH94TV9VC/giphy.gif)
